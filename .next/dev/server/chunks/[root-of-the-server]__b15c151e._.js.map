{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/1/Desktop/xxx/app/api/conversation/route.ts"],"sourcesContent":["import { OpenAI } from \"openai\";\nimport { NextResponse } from \"next/server\";\nimport { Buffer } from \"node:buffer\";\nimport { createClient } from '@supabase/supabase-js';\n\nconst openai = new OpenAI({\n  apiKey: process.env.API_KEY,\n});\n\n// Initialize Supabase Admin Client (Bypass RLS for server-side logging)\n// Initialize Supabase Admin Client (Bypass RLS for server-side logging)\nconst supabaseAdmin = createClient(\n  process.env.VITE_SUPABASE_URL!,\n  process.env.VITE_SUPABASE_SERVICE_ROLE_KEY! || process.env.VITE_SUPABASE_ANON_KEY!\n);\n\n// ✅ FIXED: Using REAL OpenAI model names\nconst MODELS = {\n  STT: \"whisper-1\",        // ✅ Real OpenAI Whisper model\n  LLM: \"gpt-4o-mini\",      // ✅ Real GPT-4o-mini model (fast & cheap)\n  TTS: \"tts-1\",            // ✅ Real TTS model\n};\n\nconst SYSTEM_PROMPT = `\nYou are Propulso, a futuristic AI Virtual Receptionist. \nAnswer briefly (max 2 sentences).\nIMPORTANT: If user asks for directions, append {{SHOW_MAP}}.\nIf user asks for a human, append {{CALL_HUMAN}}.\n`;\n\nexport async function POST(req: Request) {\n  try {\n    const formData = await req.formData();\n    const audioFile = formData.get(\"audio\") as File;\n\n    if (!audioFile) {\n      return NextResponse.json({ error: \"No audio file\" }, { status: 400 });\n    }\n\n    // 1. STT\n    const transcription = await openai.audio.transcriptions.create({\n      file: audioFile,\n      model: MODELS.STT,\n    });\n    const userText = transcription.text;\n\n    // 2. LLM\n    const completion = await openai.chat.completions.create({\n      model: MODELS.LLM,\n      messages: [\n        { role: \"system\", content: SYSTEM_PROMPT },\n        { role: \"user\", content: userText },\n      ],\n      max_tokens: 150,\n    });\n    const rawAiResponse = completion.choices[0].message.content || \"\";\n\n    let action = \"IDLE\";\n    let textToSpeak = rawAiResponse;\n\n    if (rawAiResponse.includes(\"{{SHOW_MAP}}\")) {\n      action = \"SHOW_MAP\";\n      textToSpeak = rawAiResponse.replace(\"{{SHOW_MAP}}\", \"\").trim();\n    } else if (rawAiResponse.includes(\"{{CALL_HUMAN}}\")) {\n      action = \"CALL_HUMAN\";\n      textToSpeak = rawAiResponse.replace(\"{{CALL_HUMAN}}\", \"\").trim();\n    }\n\n    /* \n    // --- DB LOGGING (Disabled to avoid duplication with Frontend which tracks full latency) ---\n    // We don't await this to avoid slowing down the response to the user\n    const startTime = new Date();\n    const logEntry = {\n      start_time: startTime.toISOString(),\n      user_query: userText,\n      department: \"General\", // Placeholder\n      status: action === 'CALL_HUMAN' ? 'escalated' : 'resolved',\n      duration: \"5s\", // Placeholder\n      metadata: {\n        latency: 0, // Placeholder\n        confidence: 0.99,\n        model: MODELS.LLM,\n        tokensUsed: 150 // Placeholder\n      },\n      messages: [\n        { role: 'user', text: userText, timestamp: startTime.toLocaleTimeString() },\n        { role: 'ai', text: textToSpeak, timestamp: new Date().toLocaleTimeString() }\n      ]\n    };\n\n    supabaseAdmin.from('logs').insert(logEntry).then(({ error }) => {\n      if (error) console.error(\"Supabase Log Error:\", error);\n    });\n    // --------------------------\n    */\n\n    // 3. TTS\n    const mp3Response = await openai.audio.speech.create({\n      model: MODELS.TTS,\n      voice: \"shimmer\",\n      input: textToSpeak,\n      response_format: \"mp3\",\n    });\n\n    const arrayBuffer = await mp3Response.arrayBuffer();\n    const audioBase64 = Buffer.from(arrayBuffer).toString(\"base64\");\n\n    return NextResponse.json({\n      user_text: userText,\n      ai_text: textToSpeak,\n      audio_base64: audioBase64,\n      action: action,\n    });\n\n  } catch (error: any) {\n    console.error(error);\n    return NextResponse.json({ error: error.message }, { status: 500 });\n  }\n}"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;AACA;AACA;;;;;AAEA,MAAM,SAAS,IAAI,+JAAM,CAAC;IACxB,QAAQ,QAAQ,GAAG,CAAC,OAAO;AAC7B;AAEA,wEAAwE;AACxE,wEAAwE;AACxE,MAAM,gBAAgB,IAAA,2MAAY,EAChC,QAAQ,GAAG,CAAC,iBAAiB,EAC7B,QAAQ,GAAG,CAAC,8BAA8B,IAAK,QAAQ,GAAG,CAAC,sBAAsB;AAGnF,yCAAyC;AACzC,MAAM,SAAS;IACb,KAAK;IACL,KAAK;IACL,KAAK;AACP;AAEA,MAAM,gBAAgB,CAAC;;;;;AAKvB,CAAC;AAEM,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,WAAW,MAAM,IAAI,QAAQ;QACnC,MAAM,YAAY,SAAS,GAAG,CAAC;QAE/B,IAAI,CAAC,WAAW;YACd,OAAO,kKAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAgB,GAAG;gBAAE,QAAQ;YAAI;QACrE;QAEA,SAAS;QACT,MAAM,gBAAgB,MAAM,OAAO,KAAK,CAAC,cAAc,CAAC,MAAM,CAAC;YAC7D,MAAM;YACN,OAAO,OAAO,GAAG;QACnB;QACA,MAAM,WAAW,cAAc,IAAI;QAEnC,SAAS;QACT,MAAM,aAAa,MAAM,OAAO,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC;YACtD,OAAO,OAAO,GAAG;YACjB,UAAU;gBACR;oBAAE,MAAM;oBAAU,SAAS;gBAAc;gBACzC;oBAAE,MAAM;oBAAQ,SAAS;gBAAS;aACnC;YACD,YAAY;QACd;QACA,MAAM,gBAAgB,WAAW,OAAO,CAAC,EAAE,CAAC,OAAO,CAAC,OAAO,IAAI;QAE/D,IAAI,SAAS;QACb,IAAI,cAAc;QAElB,IAAI,cAAc,QAAQ,CAAC,iBAAiB;YAC1C,SAAS;YACT,cAAc,cAAc,OAAO,CAAC,gBAAgB,IAAI,IAAI;QAC9D,OAAO,IAAI,cAAc,QAAQ,CAAC,mBAAmB;YACnD,SAAS;YACT,cAAc,cAAc,OAAO,CAAC,kBAAkB,IAAI,IAAI;QAChE;QAEA;;;;;;;;;;;;;;;;;;;;;;;;;;IA0BA,GAEA,SAAS;QACT,MAAM,cAAc,MAAM,OAAO,KAAK,CAAC,MAAM,CAAC,MAAM,CAAC;YACnD,OAAO,OAAO,GAAG;YACjB,OAAO;YACP,OAAO;YACP,iBAAiB;QACnB;QAEA,MAAM,cAAc,MAAM,YAAY,WAAW;QACjD,MAAM,cAAc,+HAAM,CAAC,IAAI,CAAC,aAAa,QAAQ,CAAC;QAEtD,OAAO,kKAAY,CAAC,IAAI,CAAC;YACvB,WAAW;YACX,SAAS;YACT,cAAc;YACd,QAAQ;QACV;IAEF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC;QACd,OAAO,kKAAY,CAAC,IAAI,CAAC;YAAE,OAAO,MAAM,OAAO;QAAC,GAAG;YAAE,QAAQ;QAAI;IACnE;AACF"}}]
}